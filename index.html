<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- 
    ============================================================================
    VERSÃO V10.1 (29/01/2026) - TR FIRE: SUPORTE AO BOTÃO VOLTAR (HISTORY API)
    ============================================================================
    NOVIDADES:
    - Integração com History API: O botão voltar do celular agora retrocede telas.
    - Sincronização de estado entre Navegação e Histórico do Browser.
    ============================================================================
    -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#D32F2F">
    <meta name="description" content="App de Inspeção de Extintores e Hidrantes">
    
    <!-- Configurações PWA iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TR FIRE">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/785/785116.png">
    
    <link rel="manifest" id="manifest-placeholder" href="data:application/json;base64,eyJuYW1lIjoiVFIgRklSRSIsInNob3J0X25hbWUiOiJUUiBGSVJFIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNEMzJGMkYiLCJ0aGVtZV9jb2xvciI6IiNEMzJGMkYiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0IiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzc4NS83ODUxMTYucG5nIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyJ9LHsic3JjIjoiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsYXRpY29uLmNvbS81MTIvNzg1Lzc4NTExNi5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">

    <title>TR FIRE Inspeções</title>

    <!-- DEPENDÊNCIAS -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overscroll-behavior-y: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        input, textarea, select { font-size: 16px !important; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        #reader, #reader-register { width: 100%; height: 100%; overflow: hidden; background: black; border-radius: 1rem; }
        #reader video, #reader-register video { object-fit: cover; width: 100% !important; height: 100% !important; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-scale-in { animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .toggle-checkbox:checked { right: 0; border-color: #F57C00; }
        .toggle-checkbox:checked + .toggle-label { background-color: #F57C00; }
    </style>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { red: '#D32F2F', orange: '#F57C00', black: '#212121', dark: '#121212', blue: '#1976D2' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-brand-dark h-screen w-full overflow-hidden text-gray-900 dark:text-gray-100">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, limit, doc, setDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const { useState, useEffect, useRef, useMemo } = React;
        const ReactDOM = window.ReactDOM;
        const jsPDF = window.jspdf ? window.jspdf.jsPDF : null;

        const firebaseConfig = {
            apiKey: "AIzaSyDgTmxXzb0jNi2CYsbs03FaxsnasdYVhxo",
            authDomain: "database-aero-i.firebaseapp.com",
            projectId: "database-aero-i",
            storageBucket: "database-aero-i.firebasestorage.app",
            messagingSenderId: "263237040018",
            appId: "1:263237040018:web:7e1bde9d70d55bf22a334b"
        };

        let dbFirestore = null;
        let app = null;

        try {
            app = initializeApp(firebaseConfig);
            dbFirestore = getFirestore(app);
            console.log("Firebase conectado!");
        } catch (error) {
            console.error("Erro na inicialização:", error);
        }

        const LOGO_SRC = "logo.png"; 
        const FALLBACK_LOGO = "https://cdn-icons-png.flaticon.com/512/785/785116.png";
        const LOCATION_OPTIONS = ["ANJUN", "AZUL CARGO", "AREAS COMUNS", "EQ. RESERVA", "LATAM", "MELI", "POWER SOURCE", "TOTAL EXP."];
        const ROUND_LOCATIONS = [
            "CASA DE BOMBAS / G-100", "TANQUE DE DIESEL / G-100", "RTI / G-100", "GERADOR / G-100",
            "CASA DE BOMBAS / G-200", "TANQUE DE DIESEL / G-200", "RTI / G-200", "GERADOR / G-200",
            "GERADOR / G-300"
        ];
        const ROUND_AREAS = ["G-100", "G-200", "G-300"];
        
        const formatDate = (dateStr) => {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        };

        const LogoImage = ({ className }) => (
            <img src={LOGO_SRC} onError={(e) => {e.target.onerror = null; e.target.src=FALLBACK_LOGO}} alt="Logo TR Fire" className={className} />
        );

        // =========================================================================
        // COMPONENTES COMUNS
        // =========================================================================

        const NotificationModal = ({ isOpen, message, type, isConfirmation, onClose, onConfirm }) => {
            if (!isOpen) return null;
            const colors = { error: 'bg-red-500', success: 'bg-green-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
            const icon = { error: 'fa-times', success: 'fa-check', warning: 'fa-exclamation', info: 'fa-info' };
            return (
                <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-6 animate-fade-in">
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-sm text-center shadow-2xl animate-scale-in relative border border-gray-100 dark:border-gray-700">
                        <div className={`w-20 h-20 rounded-full ${colors[type] || colors.info} flex items-center justify-center mx-auto mb-5 shadow-lg`}>
                            <i className={`fas ${icon[type] || icon.info} text-4xl text-white`}></i>
                        </div>
                        <h3 className="text-xl font-black text-gray-800 dark:text-white mb-2 uppercase">{isConfirmation ? 'Confirmação' : 'Atenção'}</h3>
                        <p className="text-gray-600 dark:text-gray-300 mb-8 text-base font-medium leading-relaxed whitespace-pre-line">{message}</p>
                        <div className="flex gap-3 justify-center">
                            {isConfirmation && (
                                <button onClick={onClose} className="flex-1 py-3.5 rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-bold active:scale-95 transition-transform">Cancelar</button>
                            )}
                            <button onClick={() => { if (isConfirmation && onConfirm) onConfirm(); onClose(); }} className={`flex-1 py-3.5 rounded-xl text-white font-bold shadow-lg active:scale-95 transition-transform ${colors[type] || colors.info}`}>
                                {isConfirmation ? 'Confirmar' : 'Entendido'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ResponsibleScreen = ({ onConfirm, usersList, unitsList, showAlert }) => {
            const [selectedName, setSelectedName] = useState("");
            const [selectedUnit, setSelectedUnit] = useState("");
            const [password, setPassword] = useState("");
            const [showPassword, setShowPassword] = useState(false);
            const handleLoginAttempt = () => {
                const nameUpper = selectedName.toUpperCase().trim();
                if (!nameUpper || !password) return;
                if (nameUpper !== "ADMIN" && !selectedUnit) { showAlert("Por favor, selecione uma Unidade.", "warning"); return; }
                const userFound = usersList.find(u => u.name === nameUpper);
                if (!userFound) { showAlert("Usuário não cadastrado.", "error"); return; }
                if (userFound.pass !== password) { showAlert("Senha incorreta.", "error"); return; }
                if (nameUpper !== "ADMIN" && userFound.unit !== "GLOBAL" && userFound.unit !== selectedUnit) { showAlert("Usuário não pertence a esta unidade.", "error"); return; }
                onConfirm(userFound.name, selectedUnit || "GLOBAL", userFound.unit === "GLOBAL" || userFound.name === "ADMIN");
            };
            const isButtonEnabled = selectedName && password && (selectedUnit || selectedName.toUpperCase().trim() === "ADMIN");
            return (
                <div className="flex flex-col h-full bg-brand-red p-4 items-center justify-center animate-fade-in relative">
                    <div className="w-28 h-28 mb-2 bg-white rounded-full p-4 shadow-2xl flex items-center justify-center"><LogoImage className="w-full h-full object-contain" /></div>
                    <h1 className="text-white text-2xl font-extrabold tracking-tight mb-1 text-center">TR FIRE <span className="text-brand-orange">INSPEÇÕES</span></h1>
                    <div className="bg-white dark:bg-gray-900 p-5 rounded-2xl shadow-2xl w-full max-w-sm space-y-3">
                        <select value={selectedUnit} onChange={(e) => setSelectedUnit(e.target.value)} className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 outline-none dark:text-white font-bold text-sm">
                            <option value="">Selecione a Unidade...</option>
                            {unitsList.map(u => <option key={u.id} value={u.name}>{u.name}</option>)}
                        </select>
                        <input type="text" value={selectedName} onChange={(e) => setSelectedName(e.target.value.toUpperCase())} placeholder="Nome do Responsável" className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 outline-none dark:text-white font-bold text-sm" />
                        <div className="relative">
                            <input type={showPassword ? "text" : "password"} value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Senha" className="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 outline-none dark:text-white font-bold text-sm" />
                            <button onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-3 text-gray-400"><i className={`fas ${showPassword ? 'fa-eye-slash' : 'fa-eye'}`}></i></button>
                        </div>
                        <button onClick={handleLoginAttempt} disabled={!isButtonEnabled} className={`w-full py-3 rounded-xl text-lg font-bold shadow-lg transition-all ${isButtonEnabled ? 'bg-brand-orange text-white' : 'bg-gray-300 text-gray-500'}`}>ENTRAR</button>
                    </div>
                </div>
            );
        };

        // =========================================================================
        // TELAS ADMIN
        // =========================================================================

        const AdminMenuScreen = ({ onNavigate }) => (
            <div className="flex flex-col h-full bg-white dark:bg-brand-dark p-6 animate-fade-in relative">
                <button onClick={() => onNavigate('menu')} className="absolute top-4 left-4 w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center shadow-sm"><i className="fas fa-arrow-left"></i></button>
                <div className="mt-16 text-center mb-8">
                    <div className="inline-flex items-center justify-center w-16 h-16 bg-gray-700 rounded-full mb-4"><i className="fas fa-cogs text-2xl text-white"></i></div>
                    <h2 className="text-2xl font-black text-gray-800 dark:text-white uppercase">ADMINISTRAÇÃO</h2>
                </div>
                <div className="w-full space-y-4">
                    <button onClick={() => onNavigate('qrRegister')} className="w-full py-4 bg-brand-orange text-white rounded-xl text-lg font-bold shadow-lg flex items-center justify-center gap-4 active:scale-95"><i className="fas fa-qrcode text-xl"></i> CADASTRAR QR-CODE</button>
                    <button onClick={() => onNavigate('accessControl')} className="w-full py-4 bg-purple-600 text-white rounded-xl text-lg font-bold shadow-lg flex items-center justify-center gap-4 active:scale-95"><i className="fas fa-user-lock text-xl"></i> ACESSOS</button>
                    <button onClick={() => onNavigate('unitRegister')} className="w-full py-4 bg-gray-600 text-white rounded-xl text-lg font-bold shadow-lg flex items-center justify-center gap-4 active:scale-95"><i className="fas fa-building text-xl"></i> UNIDADES</button>
                    <button onClick={() => onNavigate('userRegister')} className="w-full py-4 bg-gray-700 text-white rounded-xl text-lg font-bold shadow-lg flex items-center justify-center gap-4 active:scale-95"><i className="fas fa-user-plus text-xl"></i> BOMBEIROS</button>
                </div>
            </div>
        );

        const QRRegisterScreen = ({ onNavigate, showAlert }) => {
            const [qrId, setQrId] = useState("");
            const [name, setName] = useState("");
            const [type, setType] = useState("EXTINTOR");
            const [scanning, setScanning] = useState(false);
            const scannerRef = useRef(null);

            const startScan = () => {
                setScanning(true);
                const html5QrCode = new Html5Qrcode("reader-register");
                scannerRef.current = html5QrCode;
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
                    setQrId(decodedText);
                    stopScan();
                    showAlert("Código lido!", "success");
                }, () => {}).catch(err => showAlert("Erro ao ligar câmera", "error"));
            };

            const stopScan = () => {
                if (scannerRef.current) {
                    scannerRef.current.stop().then(() => { scannerRef.current.clear(); setScanning(false); }).catch(() => setScanning(false));
                }
            };

            const handleSave = async () => {
                if (!qrId || !name) return showAlert("ID e Nome obrigatórios!", "warning");
                try {
                    await setDoc(doc(dbFirestore, "equipment_registry", qrId), {
                        qrId, equipmentName: name.toUpperCase(), type, created_at: new Date().toISOString()
                    });
                    showAlert("Equipamento vinculado com sucesso!", "success");
                    setQrId(""); setName("");
                } catch (e) { showAlert("Erro ao guardar dados.", "error"); }
            };

            return (
                <div className="flex flex-col h-full bg-white dark:bg-brand-dark p-6 overflow-y-auto relative animate-fade-in">
                    <button onClick={() => { stopScan(); onNavigate('adminMenu'); }} className="absolute top-4 left-4 w-10 h-10 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center"><i className="fas fa-arrow-left"></i></button>
                    <div className="mt-12 text-center mb-6">
                        <i className="fas fa-qrcode text-4xl text-brand-orange mb-2"></i>
                        <h2 className="text-xl font-black">VINCULAR QR-CODE</h2>
                    </div>
                    <div className="space-y-4">
                        <div id="reader-register" className={`${scanning ? 'h-64' : 'hidden'} mb-4 shadow-xl`}></div>
                        {!scanning ? (
                            <button onClick={startScan} className="w-full py-4 bg-gray-800 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg"><i className="fas fa-camera"></i> ESCANEAR QR-CODE</button>
                        ) : (
                            <button onClick={stopScan} className="w-full py-4 bg-red-600 text-white rounded-xl font-bold shadow-lg">PARAR CÂMERA</button>
                        )}
                        <div><label className="text-xs font-bold text-gray-500 uppercase block mb-1">ID (QR-CODE)</label><input value={qrId} onChange={e => setQrId(e.target.value)} placeholder="Leia ou digite o código..." className="w-full p-4 bg-gray-50 dark:bg-gray-800 rounded-xl font-mono border-2 border-dashed border-brand-orange outline-none dark:text-white" /></div>
                        <div><label className="text-xs font-bold text-gray-500 uppercase block mb-1">Identificação / Nome</label><input value={name} onChange={e => setName(e.target.value)} placeholder="Ex: Extintor PQS Galpão B" className="w-full p-4 bg-gray-50 dark:bg-gray-800 rounded-xl font-bold outline-none dark:text-white" /></div>
                        <div><label className="text-xs font-bold text-gray-500 uppercase block mb-1">Tipo de Ponto</label>
                            <select value={type} onChange={e => setType(e.target.value)} className="w-full p-4 bg-gray-50 dark:bg-gray-800 rounded-xl font-bold outline-none dark:text-white">
                                <option value="EXTINTOR">EXTINTOR</option><option value="HIDRANTE">HIDRANTE</option><option value="PONTO_RONDA">PONTO DE RONDA</option>
                            </select>
                        </div>
                        <button onClick={handleSave} className="w-full py-4 bg-brand-orange text-white rounded-xl text-lg font-bold shadow-lg active:scale-95 transition-all">SALVAR EQUIPAMENTO</button>
                    </div>
                </div>
            );
        };

        // --- OUTRAS TELAS ADMIN ---
        const UnitRegisterScreen = ({ onNavigate, onSaveUnit, unitsList, onUpdateUnit, onDeleteUnit, showAlert, showConfirm }) => {
            const [newUnit, setNewUnit] = useState({ name: '', address: '' });
            const [editingId, setEditingId] = useState(null);
            const handleSave = async () => {
                if (!newUnit.name || !newUnit.address) return showAlert("Preencha nome e endereço.", "warning");
                if (editingId) { await onUpdateUnit(editingId, { name: newUnit.name.toUpperCase(), address: newUnit.address.toUpperCase() }); setEditingId(null); } 
                else { await onSaveUnit({ name: newUnit.name.toUpperCase(), address: newUnit.address.toUpperCase() }); }
                setNewUnit({ name: '', address: '' });
            };
            return (
                <div className="flex flex-col h-full bg-white dark:bg-brand-dark p-6 overflow-y-auto animate-fade-in relative">
                    <button onClick={() => onNavigate('adminMenu')} className="absolute top-4 left-4 w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center"><i className="fas fa-arrow-left"></i></button>
                    <div className="mt-16 text-center mb-6"><h2 className="text-2xl font-black uppercase">UNIDADES</h2></div>
                    <div className="space-y-3 mb-6">
                        <input value={newUnit.name} onChange={e => setNewUnit({...newUnit, name: e.target.value})} placeholder="Nome da Unidade" className="w-full p-4 bg-gray-100 dark:bg-gray-800 rounded-xl font-bold outline-none dark:text-white" />
                        <input value={newUnit.address} onChange={e => setNewUnit({...newUnit, address: e.target.value})} placeholder="Endereço" className="w-full p-4 bg-gray-100 dark:bg-gray-800 rounded-xl font-bold outline-none dark:text-white" />
                        <button onClick={handleSave} className="w-full py-4 bg-brand-orange text-white rounded-xl font-bold shadow-lg uppercase">{editingId ? 'Actualizar' : 'Cadastrar'}</button>
                    </div>
                    <div className="space-y-2">
                        {unitsList.map(u => (
                            <div key={u.id} className="p-4 bg-gray-50 dark:bg-gray-900 rounded-xl flex justify-between items-center shadow-sm">
                                <div><p className="font-bold dark:text-white">{u.name}</p><p className="text-xs text-gray-500">{u.address}</p></div>
                                <div className="flex gap-2">
                                    <button onClick={() => { setEditingId(u.id); setNewUnit({name: u.name, address: u.address}); }} className="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><i className="fas fa-pen text-xs"></i></button>
                                    <button onClick={() => showConfirm("Eliminar unidade?", () => onDeleteUnit(u.id), "error")} className="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center"><i className="fas fa-trash text-xs"></i></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const UserRegisterScreen = ({ onNavigate, onSaveUser, usersList, unitsList, onUpdateUser, onDeleteUser, showAlert, showConfirm }) => {
            const [newUser, setNewUser] = useState({ name: '', pass: '', unit: '' });
            const [editingId, setEditingId] = useState(null);
            const handleSave = async () => {
                if (!newUser.name || !newUser.pass || !newUser.unit) return showAlert("Preencha todos os campos.", "warning");
                if (editingId) { await onUpdateUser(editingId, { name: newUser.name.toUpperCase(), pass: newUser.pass, unit: newUser.unit }); setEditingId(null); } 
                else { await onSaveUser({ name: newUser.name.toUpperCase(), pass: newUser.pass, unit: newUser.unit }); }
                setNewUser({ name: '', pass: '', unit: '' });
            };
            return (
                <div className="flex flex-col h-full bg-white dark:bg-brand-dark p-6 overflow-y-auto animate-fade-in relative">
                    <button onClick={() => onNavigate('adminMenu')} className="absolute top-4 left-4 w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center"><i className="fas fa-arrow-left"></i></button>
                    <div className="mt-16 text-center mb-6"><h2 className="text-2xl font-black uppercase">BOMBEIROS</h2></div>
                    <div className="space-y-3 mb-6">
                        <select value={newUser.unit} onChange={e => setNewUser({...newUser, unit: e.target.value})} className="w-full p-4 bg-gray-100 dark:bg-gray-800 rounded-xl font-bold outline-none dark:text-white appearance-none">
                            <option value="">Seleccione Unidade...</option>{unitsList.map(u => <option key={u.id} value={u.name}>{u.name}</option>)}
                        </select>
                        <input value={newUser.name} onChange={e => setNewUser({...newUser, name: e.target.value})} placeholder="Nome do Bombeiro" className="w-full p-4 bg-gray-100 dark:bg-gray-800 rounded-xl font-bold outline-none dark:text-white uppercase" />
                        <input value={newUser.pass} onChange={e => setNewUser({...newUser, pass: e.target.value})} placeholder="Senha de Acesso" className="w-full p-4 bg-gray-100 dark:bg-gray-800 rounded-xl font-bold outline-none dark:text-white" />
                        <button onClick={handleSave} className="w-full py-4 bg-brand-orange text-white rounded-xl font-bold shadow-lg uppercase">{editingId ? 'Actualizar' : 'Cadastrar'}</button>
                    </div>
                    <div className="space-y-2">
                        {usersList.map(u => (
                            <div key={u.id} className="p-4 bg-gray-50 dark:bg-gray-900 rounded-xl flex justify-between items-center shadow-sm">
                                <div><p className="font-bold dark:text-white">{u.name}</p><p className="text-xs text-blue-500 font-bold">{u.unit}</p></div>
                                <div className="flex gap-2">
                                    <button onClick={() => { setEditingId(u.id); setNewUser({name: u.name, pass: u.pass, unit: u.unit}); }} className="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><i className="fas fa-pen text-xs"></i></button>
                                    <button onClick={() => showConfirm("Eliminar utilizador?", () => onDeleteUser(u.id), "error")} className="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center"><i className="fas fa-trash text-xs"></i></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const AccessControlScreen = ({ onNavigate, usersList, onUpdatePermissions }) => {
            const [selectedUser, setSelectedUser] = useState(null);
            const PERMISSIONS = [
                { id: 'EXTINTOR', label: 'Extintores' }, { id: 'HIDRANTE', label: 'Hidrantes' },
                { id: 'HISTORICO', label: 'Histórico' }, { id: 'RONDA', label: 'Ronda Diária' }
            ];
            const togglePermission = (permId) => {
                if (!selectedUser) return;
                const currentPerms = selectedUser.permissions || [];
                const newPerms = currentPerms.includes(permId) ? currentPerms.filter(p => p !== permId) : [...currentPerms, permId];
                setSelectedUser({ ...selectedUser, permissions: newPerms });
                onUpdatePermissions(selectedUser.id, newPerms);
            };
            return (
                <div className="flex flex-col h-full bg-white dark:bg-brand-dark p-6 animate-fade-in overflow-y-auto relative">
                    <button onClick={() => selectedUser ? setSelectedUser(null) : onNavigate('adminMenu')} className="absolute top-4 left-4 w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center"><i className="fas fa-arrow-left"></i></button>
                    <div className="mt-16 text-center mb-8"><h2 className="text-2xl font-black uppercase">{selectedUser ? 'Permissões' : 'Acessos'}</h2></div>
                    {!selectedUser ? (
                        <div className="space-y-3">
                            {usersList.filter(u => u.name !== 'ADMIN').map(u => (
                                <div key={u.id} onClick={() => setSelectedUser(u)} className="p-4 bg-gray-50 dark:bg-gray-900 rounded-xl flex justify-between items-center shadow-sm cursor-pointer active:scale-95 transition-transform border border-transparent hover:border-brand-orange">
                                    <div><p className="font-bold dark:text-white">{u.name}</p><p className="text-[10px] text-gray-500 uppercase">{(u.permissions || []).length} ACESSOS ATIVOS</p></div>
                                    <i className="fas fa-chevron-right text-gray-300"></i>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="space-y-4">
                            <p className="font-black text-center text-brand-orange mb-4">Configurando: {selectedUser.name}</p>
                            {PERMISSIONS.map(perm => {
                                const isEnabled = (selectedUser.permissions || []).includes(perm.id);
                                return (
                                    <div key={perm.id} className="bg-gray-100 dark:bg-gray-800 p-4 rounded-xl flex items-center justify-between shadow-sm">
                                        <span className="font-bold dark:text-white">{perm.label}</span>
                                        <div onClick={() => togglePermission(perm.id)} className={`w-12 h-6 rounded-full relative cursor-pointer transition-colors ${isEnabled ? 'bg-brand-orange' : 'bg-gray-300'}`}>
                                            <div className={`absolute top-1 w-4 h-4 rounded-full bg-white transition-all ${isEnabled ? 'right-1' : 'left-1'}`}></div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        // =========================================================================
        // TELAS OPERACIONAIS
        // =========================================================================

        const MenuScreen = ({ onNavigate, responsibleName, currentUnit, onStartInspection, usersList }) => {
            const isAdmin = responsibleName === "ADMIN" || currentUnit === "GLOBAL";
            const currentUserObj = usersList.find(u => u.name === responsibleName);
            const userPerms = currentUserObj?.permissions || ['EXTINTOR', 'HIDRANTE', 'HISTORICO']; 
            const hasAccess = (perm) => isAdmin || userPerms.includes(perm);
            const handleLogout = () => { localStorage.removeItem('trfire_user'); window.location.reload(); };

            return (
                <div className="flex flex-col h-full bg-white dark:bg-brand-dark p-6 animate-fade-in relative">
                    <div className="absolute top-0 left-0 w-full bg-gray-100 dark:bg-gray-800 p-3 px-6 flex justify-between items-center text-xs shadow-sm">
                        <div className="flex flex-col"><span className="font-black">Olá, {responsibleName}</span><span className="text-[10px] text-brand-orange font-bold uppercase">{currentUnit}</span></div>
                        <button onClick={handleLogout} className="text-brand-red font-bold uppercase"><i className="fas fa-sign-out-alt"></i> Sair</button>
                    </div>
                    <div className="flex-1 flex flex-col items-center justify-center space-y-6 mt-10 overflow-y-auto w-full">
                        <LogoImage className="w-32 h-32 filter drop-shadow-xl" />
                        <h1 className="text-2xl font-black">TR FIRE <span className="text-brand-orange">INSPEÇÕES</span></h1>
                        <div className="w-full space-y-3 pb-8">
                            {hasAccess('RONDA') && <button onClick={() => onNavigate('roundsLocation')} className="w-full py-5 bg-brand-blue text-white rounded-2xl text-lg font-black shadow-lg flex items-center justify-center gap-4 active:scale-95"><i className="fas fa-clipboard-check text-2xl"></i> RONDA DIÁRIA</button>}
                            {hasAccess('EXTINTOR') && <button onClick={() => onStartInspection('EXTINTOR')} className="w-full py-5 bg-brand-red text-white rounded-2xl text-lg font-black shadow-lg flex items-center justify-center gap-4 active:scale-95"><i className="fas fa-fire-extinguisher text-2xl"></i> EXTINTORES</button>}
                            {hasAccess('HIDRANTE') && <button onClick={() => onStartInspection('HIDRANTE')} className="w-full py-5 bg-brand-orange text-white rounded-2xl text-lg font-black shadow-lg flex items-center justify-center gap-4 active:scale-95"><i className="fas fa-faucet text-2xl"></i> HIDRANTES</button>}
                            {hasAccess('HISTORICO') && <button onClick={() => onNavigate('list')} className="w-full py-5 bg-gray-800 text-white rounded-2xl text-lg font-black shadow-lg flex items-center justify-center gap-4 active:scale-95"><i className="fas fa-database text-xl"></i> HISTÓRICO</button>}
                            {isAdmin && <button onClick={() => onNavigate('adminMenu')} className="w-full py-5 bg-cyan-700 text-white rounded-2xl text-lg font-black shadow-lg flex items-center justify-center gap-4 active:scale-95"><i className="fas fa-cogs text-xl"></i> ADMINISTRAÇÃO</button>}
                        </div>
                    </div>
                </div>
            );
        };

        const ScannerScreen = ({ onNavigate, onScanSuccess, db, inspectionType, showAlert }) => {
            const scannerRef = useRef(null);
            useEffect(() => {
                const scanner = new Html5Qrcode("reader");
                scannerRef.current = scanner;
                scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async (decodedText) => {
                    await scanner.stop();
                    scanner.clear();
                    let finalData = { equipmentId: decodedText, equipmentName: decodedText, isLinked: false };
                    try {
                        const docRef = doc(dbFirestore, "equipment_registry", decodedText);
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const reg = docSnap.data();
                            finalData.equipmentName = reg.equipmentName;
                            finalData.type = reg.type;
                            finalData.isLinked = true;
                        }
                    } catch (e) { console.error("Erro na busca de QR:", e); }
                    if (inspectionType !== 'RONDA') {
                        const currentMonth = new Date().toISOString().slice(0, 7); 
                        const isDuplicate = db.some(item => !item.deleted && (item.equipmentId || '').toString() === decodedText && item.created_at.startsWith(currentMonth));
                        if (isDuplicate) { 
                            showAlert(`⚠️ JÁ VISTORIADO!\nEste código já foi registado este mês.`, "warning"); 
                            onNavigate('menu'); return; 
                        }
                    }
                    onScanSuccess(finalData);
                }).catch(err => console.error(err));
                return () => { if (scanner.isScanning) scanner.stop().then(() => scanner.clear()).catch(() => {}); };
            }, [db, inspectionType]);
            return (
                <div className="flex flex-col h-full bg-black relative">
                    <button onClick={() => onNavigate('menu')} className="absolute top-4 left-4 z-20 text-white bg-black/40 w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-sm"><i className="fas fa-arrow-left"></i></button>
                    <div className="flex-1 flex flex-col items-center justify-center"><div id="reader" className="w-full max-w-md bg-black"></div><p className="text-white font-bold mt-4 animate-pulse">Aponte para o QR Code</p></div>
                </div>
            );
        };

        const FormScreen = ({ initialData, onNavigate, onSave, responsibleName, inspectionType, showAlert }) => {
            const [isSaving, setIsSaving] = useState(false);
            const [form, setForm] = useState({ 
                type: initialData?.type || inspectionType, 
                equipmentId: initialData?.equipmentId || '', 
                equipmentName: initialData?.equipmentName || '', 
                isLinked: initialData?.isLinked || false,
                moduleLocation: '', hasId: null, floorSign: null, q1: null, q2: null, nextRecharge: '', h_complete: null, h_unobstructed: null, h_seal_broken: null, nextHydro: '', obs: '', responsible: responsibleName, created_at: new Date().toISOString(), deleted: false 
            });
            const handleSave = async () => { if (!form.equipmentId || !form.moduleLocation) return showAlert("Preencha campos obrigatórios (*)", "warning"); setIsSaving(true); await onSave(form); setIsSaving(false); };
            const handleDateInput = (v) => { v = v.replace(/\D/g, '').slice(0,6); if (v.length >= 2) return v.slice(0, 2) + '/' + v.slice(2); return v; };
            const ColorSelect = ({ label, val, field, invert=false }) => { 
                let bgClass = "bg-white dark:bg-gray-800"; 
                if(val === true) bgClass = invert ? "bg-red-100 border-red-500" : "bg-green-100 border-green-500"; 
                else if(val === false) bgClass = invert ? "bg-green-100 border-green-500" : "bg-red-100 border-red-500"; 
                return (
                    <div className={`p-3 rounded-xl border-2 transition-all ${val !== null ? bgClass : 'border-gray-100 dark:border-gray-700'}`}>
                        <p className="text-[10px] font-black uppercase mb-1 text-gray-500">{label}</p>
                        <select value={val === null ? '' : (val ? 'true' : 'false')} onChange={(e) => { const v = e.target.value; setForm({...form, [field]: v === '' ? null : (v === 'true')}); }} className="w-full bg-transparent font-bold outline-none appearance-none dark:text-white">
                            <option value="">Selecionar...</option><option value="true">Sim</option><option value="false">Não</option>
                        </select>
                    </div>
                ); 
            };
            return (
                <div className="flex flex-col h-full bg-gray-50 dark:bg-black overflow-hidden animate-fade-in">
                    <div className="bg-white dark:bg-gray-900 p-4 shadow-sm flex items-center justify-between sticky top-0 z-20">
                        <button onClick={() => onNavigate('menu')} className="w-8 h-8 text-gray-600 dark:text-white"><i className="fas fa-arrow-left"></i></button>
                        <h2 className="text-lg font-black uppercase">{form.type}</h2>
                        <button onClick={handleSave} disabled={isSaving} className="bg-brand-red text-white px-5 py-2 rounded-xl font-black shadow-md">{isSaving ? '...' : 'SALVAR'}</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 pb-20">
                        <div className={`p-4 rounded-xl border-2 ${form.isLinked ? 'bg-green-50 border-green-500' : 'bg-blue-50 border-blue-500'}`}>
                            <label className="text-[10px] font-black text-gray-400 uppercase">Equipamento Identificado</label>
                            <input value={form.equipmentName} onChange={e=>setForm({...form, equipmentName:e.target.value})} readOnly={form.isLinked} placeholder="Nome do Equipamento" className="w-full bg-transparent font-black text-xl outline-none dark:text-gray-800 mt-1"/>
                            {form.isLinked && <p className="text-[9px] text-green-600 font-bold mt-1 uppercase"><i className="fas fa-check-circle"></i> Vínculo confirmado via QR-Code</p>}
                        </div>
                        <div className="bg-white dark:bg-gray-800 p-3 rounded-xl border-2 border-gray-100 dark:border-gray-700">
                            <label className="text-xs text-gray-400 font-bold uppercase">Módulo / Setor *</label>
                            <select value={form.moduleLocation} onChange={e=>setForm({...form, moduleLocation:e.target.value})} className="w-full bg-transparent font-black dark:text-white outline-none appearance-none mt-1">
                                <option value="">Selecione o local...</option>{LOCATION_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                            </select>
                        </div>
                        {form.type === 'EXTINTOR' ? (
                            <><div className="grid grid-cols-2 gap-3"><ColorSelect label="Sinalização?" field="hasId" val={form.hasId} /><ColorSelect label="Pintura Solo?" field="floorSign" val={form.floorSign} /></div><div className="grid grid-cols-2 gap-3"><ColorSelect label="Lacre Rompido?" field="q1" val={form.q1} invert={true} /><ColorSelect label="Obstruído?" field="q2" val={form.q2} invert={true} /></div><div className="grid grid-cols-2 gap-3"><div className="bg-white dark:bg-gray-800 p-3 rounded-xl border-2 border-gray-100"><label className="text-[10px] font-bold text-gray-400 uppercase">Próx. Recarga</label><input value={form.nextRecharge} onChange={e=>setForm({...form, nextRecharge: handleDateInput(e.target.value)})} placeholder="MM/AAAA" className="w-full bg-transparent font-black dark:text-white mt-1"/></div><div className="bg-white dark:bg-gray-800 p-3 rounded-xl border-2 border-gray-100"><label className="text-[10px] font-bold text-gray-400 uppercase">Teste Hidro.</label><input value={form.nextHydro} onChange={e=>setForm({...form, nextHydro: handleDateInput(e.target.value)})} placeholder="MM/AAAA" className="w-full bg-transparent font-black dark:text-white mt-1"/></div></div></>
                        ) : (
                            <><div className="grid grid-cols-2 gap-3"><ColorSelect label="Completo?" field="h_complete" val={form.h_complete} /><ColorSelect label="Desobstruído?" field="h_unobstructed" val={form.h_unobstructed} /></div><div className="grid grid-cols-2 gap-3"><div className="bg-white dark:bg-gray-800 p-3 rounded-xl border-2 border-gray-100"><label className="text-[10px] font-bold text-gray-400 uppercase">Próx. Teste Hidro</label><input value={form.nextHydro} onChange={e=>setForm({...form, nextHydro: handleDateInput(e.target.value)})} placeholder="MM/AAAA" className="w-full bg-transparent font-black dark:text-white mt-1"/></div><ColorSelect label="Lacre Rompido?" field="h_seal_broken" val={form.h_seal_broken} invert={true} /></div></>
                        )}
                        <textarea value={form.obs} onChange={e=>setForm({...form, obs:e.target.value})} placeholder="Observações..." className="w-full p-4 rounded-xl shadow-sm h-32 resize-none bg-white dark:bg-gray-800 dark:text-white border-2 border-gray-100 dark:border-gray-700"></textarea>
                    </div>
                </div>
            );
        };

        function App() {
            const [page, setPage] = useState(localStorage.getItem('trfire_user') ? 'menu' : 'responsible');
            const [responsible, setResponsible] = useState(localStorage.getItem('trfire_user') || '');
            const [currentUnit, setCurrentUnit] = useState(localStorage.getItem('trfire_unit') || '');
            const [inspectionType, setInspectionType] = useState('EXTINTOR');
            const [db, setDb] = useState([]);
            const [users, setUsers] = useState([]);
            const [units, setUnits] = useState([]);
            const [scanRes, setScanRes] = useState(null);
            const [notification, setNotification] = useState({ isOpen: false, message: '', type: 'info', isConfirmation: false, onConfirm: null });

            const showAlert = (message, type = 'info') => setNotification({ isOpen: true, message, type, isConfirmation: false });
            const showConfirm = (message, onConfirm, type = 'warning') => setNotification({ isOpen: true, message, type, isConfirmation: true, onConfirm });

            // =========================================================================
            // LÓGICA DO BOTÃO VOLTAR (HISTORY API)
            // =========================================================================
            useEffect(() => {
                const handlePopState = (event) => {
                    if (event.state && event.state.page) {
                        setPage(event.state.page);
                    } else if (page !== 'responsible') {
                        // Se não houver estado no histórico, volta para o menu ou login
                        const target = localStorage.getItem('trfire_user') ? 'menu' : 'responsible';
                        if (page !== target) setPage(target);
                    }
                };

                window.addEventListener('popstate', handlePopState);
                
                // Define o estado inicial se não existir
                if (!window.history.state) {
                    window.history.replaceState({ page }, '');
                }

                return () => window.removeEventListener('popstate', handlePopState);
            }, []);

            // Sincroniza o histórico sempre que a página mudar manualmente (setPage)
            useEffect(() => {
                if (window.history.state?.page !== page) {
                    window.history.pushState({ page }, '');
                }
            }, [page]);

            useEffect(() => {
                if (!dbFirestore) return;
                const q = query(collection(dbFirestore, "inspections"), orderBy("created_at", "desc"), limit(200));
                const unsub = onSnapshot(q, (snap) => { const list = []; snap.forEach(d => list.push({id: d.id, ...d.data()})); setDb(list); });
                const unsubUsers = onSnapshot(collection(dbFirestore, "users"), (snap) => { const list = []; snap.forEach(d => list.push({id: d.id, ...d.data()})); setUsers(list); });
                const unsubUnits = onSnapshot(collection(dbFirestore, "units"), (snap) => { const list = []; snap.forEach(d => list.push({id: d.id, ...d.data()})); setUnits(list); });
                return () => { unsub(); unsubUsers(); unsubUnits(); };
            }, []);

            const handleLogin = (n, u) => { localStorage.setItem('trfire_user', n); localStorage.setItem('trfire_unit', u); setResponsible(n); setCurrentUnit(u); setPage('menu'); };
            const handleSave = async (data) => { await addDoc(collection(dbFirestore, "inspections"), { ...data, unit: currentUnit }); setPage('list'); };

            return (
                <div className="h-full w-full">
                    <NotificationModal isOpen={notification.isOpen} message={notification.message} type={notification.type} isConfirmation={notification.isConfirmation} onConfirm={notification.onConfirm} onClose={() => setNotification({...notification, isOpen: false})} />
                    
                    {page === 'responsible' && <ResponsibleScreen onConfirm={handleLogin} usersList={users} unitsList={units} showAlert={showAlert} />}
                    {page === 'menu' && <MenuScreen onNavigate={setPage} responsibleName={responsible} currentUnit={currentUnit} onStartInspection={(t) => { setInspectionType(t); setPage('scan'); }} usersList={users} />}
                    {page === 'adminMenu' && <AdminMenuScreen onNavigate={setPage} />}
                    {page === 'qrRegister' && <QRRegisterScreen onNavigate={setPage} showAlert={showAlert} />}
                    {page === 'unitRegister' && <UnitRegisterScreen onNavigate={setPage} onSaveUnit={(d)=>addDoc(collection(dbFirestore, "units"), d)} unitsList={units} onUpdateUnit={(id, d)=>updateDoc(doc(dbFirestore, "units", id), d)} onDeleteUnit={(id)=>deleteDoc(doc(dbFirestore, "units", id))} showAlert={showAlert} showConfirm={showConfirm} />}
                    {page === 'userRegister' && <UserRegisterScreen onNavigate={setPage} onSaveUser={(d)=>addDoc(collection(dbFirestore, "users"), d)} usersList={users} unitsList={units} onUpdateUser={(id, d)=>updateDoc(doc(dbFirestore, "users", id), d)} onDeleteUser={(id)=>deleteDoc(doc(dbFirestore, "users", id))} showAlert={showAlert} showConfirm={showConfirm} />}
                    {page === 'accessControl' && <AccessControlScreen onNavigate={setPage} usersList={users} onUpdatePermissions={(id, p)=>updateDoc(doc(dbFirestore, "users", id), {permissions: p})} />}
                    {page === 'scan' && <ScannerScreen onNavigate={setPage} onScanSuccess={(d)=>{setScanRes(d); setPage('form');}} db={db} inspectionType={inspectionType} showAlert={showAlert} />}
                    {page === 'form' && <FormScreen initialData={scanRes} onNavigate={setPage} responsibleName={responsible} inspectionType={inspectionType} onSave={handleSave} showAlert={showAlert} />}
                    {page === 'list' && <div className="p-10 text-center flex flex-col items-center justify-center h-full space-y-4"><i className="fas fa-check-circle text-green-500 text-6xl animate-bounce"></i><h2 className="text-xl font-bold">REGISTRO SALVO!</h2><button onClick={()=>setPage('menu')} className="bg-brand-red p-4 text-white rounded-xl font-bold w-full max-w-xs shadow-lg uppercase">Voltar ao Menu</button></div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
